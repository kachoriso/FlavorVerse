name: Deploy FlavorVerse to AWS

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        echo "Installing dependencies..."
        # å¿…è¦ã«å¿œã˜ã¦ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ 
        
    - name: Build application
      run: |
        echo "Building FlavorVerse app..."
        # å¿…è¦ã«å¿œã˜ã¦ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ 
        
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-northeast-1
        
    - name: Deploy to S3
      run: |
        echo "Deploying to S3 bucket: flavorverse-app"
        aws s3 sync . s3://flavorverse-app --delete \
          --exclude "*.git*" \
          --exclude ".github/*" \
          --exclude "*.md" \
          --exclude "cloudfront-config.json" \
          --exclude "route53-*.json" \
          --exclude "proxy-server.py" \
          --exclude "*.pyc" \
          --exclude "__pycache__/*"
        
    - name: Invalidate CloudFront
      run: |
        echo "Invalidating CloudFront distribution: E3ITJAY74UEV1K"
        aws cloudfront create-invalidation \
          --distribution-id E3ITJAY74UEV1K \
          --paths "/*"
          
    - name: Deployment Summary
      run: |
        echo "ğŸš€ Deployment completed successfully!"
        echo "ğŸ“¦ S3 Bucket: flavorverse-app"
        echo "ğŸŒ CloudFront: https://dk15qupa8re32.cloudfront.net"
        echo "ğŸ“ Files deployed: $(aws s3 ls s3://flavorverse-app --recursive | wc -l) files"
